{{- /* Credits go to Joe Mooring who authored this markdown render hook:
     https://github.com/jmooring/hugo-testing/blob/hugo-forum-topic-36924/layouts/_default/_markup/render-codeblock-kroki.html
     Renders diagrams from textual descriptions to SVG images using the Kroki service.

References:

- https://kroki.io/
- https://kroki.io/#examples

@param {obj} .Attributes The generic attributes from the info string.
@param {string} .Inner The content between the leading and trailing code fences, excluding the info string.
@param {obj} .Options The highlighting options from the info string.
@param {int} .Ordinal The zero-based ordinal of the code block on the page.
@param {obj} .Page A reference to the page containing the code block.
@param {obj} .Position The position of the code block within the page content.
@param {string} .Type The first word of the info string.
*/}}

{{- /* Initialize variables. */}}

{{ $attrs := dict -}}
{{ if .isShortcode -}}
  {{ $attrs = .parameters -}}
{{ else -}}
  {{ $attrs = .context.Attributes -}}
{{ end -}}

{{- $position := .context.Position }}

{{- $sourceDiagram := .diagramSource }}

{{- $url := "https://kroki.io/" }}
{{- with .context.Page.Site.Params.kroki.kroki_server }}
  {{- $url = . }}
{{- end }}
{{- $outputFormat := "svg" }}
{{- with $attrs.format }}
  {{- $outputFormat = . }}
{{- end }}

{{ $codeBlock := "kroki" -}}
{{ with .type -}}
  {{ $codeBlock = . -}}
  {{ with $.block -}}
    {{ $codeBlock = . -}}
  {{ end -}}
{{ end -}}

{{- $diagramOptions := dict }}
{{ with .options }}
  {{ range $key, $value := .options -}}
    {{ $diagramOptions = merge $diagramOptions ( dict $key $value ) -}}
  {{ end -}}
{{ end -}}

{{- $supportedAttributes := slice "disabled" "format" "type" }}
{{- range .validAttributes }}
  {{- $supportedAttributes = $supportedAttributes | append . }}
{{- end }}

{{- $attributesDelimited := delimit $supportedAttributes ", " " and " }}

{{- if or .do_not_validate .isShortcode }}
  {{/* do nothing */}}
{{ else }}
  {{ range $key, $value := .context.Attributes -}}
    {{- if not ( in $supportedAttributes $key ) -}}
      {{ errorf "Code block %q: invalid attribute %q passed. Valid attributes are %s. See %s" $.type $key $attributesDelimited $position -}}
    {{ end -}}
  {{ end -}}
{{ end -}}

{{- $supportedTypes := slice
  "actdiag" "blockdiag" "bpmn" "bytefield" "c4plantuml" "d2" "dbml" "ditaa" "erd" "excalidraw" "graphviz" "mermaid"
  "nomnoml" "nwdiag" "packetdiag" "pikchr" "plantuml" "rackdiag" "seqdiag" "structurizr"
  "svgbob" "umlet" "vega" "vegalite" "wavedrom" "wireviz"
}}
{{- $typesDelimited := delimit $supportedTypes ", " " and " }}

{{/* Add attributes. */}}
{{- $id := printf "kroki-%d" ( add 1 .context.Ordinal) }}
{{- $class := "" }}
{{- with $attrs.class }}
  {{- $class = printf "diagram diagram-kroki diagram-kroki-%s %s" .type $attrs.class }}
{{- else }}
  {{- $class = printf "diagram diagram-kroki diagram-kroki-%s" .type }}
{{- end }}
{{- $attrs := merge $attrs (dict "class" $class "id" $id "alt" "diagram") }}

{{- /* Render diagram */}}

{{- with $diagramType := .type  | lower }}
  {{- if or $attrs.disabled $.context.Page.Site.Params.kroki.disabled }}
    {{- warnf "Disabled code block %q at %s." ( $.type | lower ) $position }}
  {{- else }}
    {{- with $sourceDiagram }}
      {{- $kroki := dict
        "diagram_source" .
        "diagram_type" $diagramType
        "output_format" $outputFormat
        "diagram_options" $diagramOptions
      }}
      {{- $opts := dict
        "method" "post"
        "body" ($kroki | jsonify)
      }}
      {{- with resources.GetRemote $url $opts }}
        {{- with .Err }}
          {{- errorf "Code block %q: %s. Reason: %s. See %s" $codeBlock . .Data.Body $position }}
        {{- else }}
          {{ if eq $outputFormat "pdf" -}}
          {{- $attrs = merge $attrs (dict "href" .RelPermalink) }}
          <a
              {{- range $k, $v := $attrs }}
              {{- if not (eq $k "type") }}
                {{- printf " %s=%q" $k $v | safeHTMLAttr }}
              {{- end }}
            {{- end -}}
            >Diagram</a>
            {{ else if or (eq $outputFormat "txt") (eq $outputFormat "utxt") -}}
              {{ highlight .Content "plain" }}
            {{ else -}}
            {{- $attrs = merge $attrs (dict "src" (cond (eq $outputFormat "base64") .Content .RelPermalink )) }}
            <img
              {{- range $k, $v := $attrs }}
                {{- if not (eq $k "type") }}
                  {{- printf " %s=%q" $k $v | safeHTMLAttr }}
                {{- end }}
              {{- end -}}
            >
          {{ end -}}
        {{- end }}
      {{- else }}
        {{- errorf "Code block %q: unable to get the remote diagram. $codeBlock See %s" $position }}
      {{- end }}
    {{- else }}
      {{- warnf "Code block %q: empty body, cannot create diagram . See %s" $codeBlock $position }}
    {{- end }}
  {{- end }}
{{- else }}
  {{- errorf "Code block %q: missing %q attribute. Valid types are %s. See %s" $codeBlock "type" $typesDelimited $position }}
{{- end }}
